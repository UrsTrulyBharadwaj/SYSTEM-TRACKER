<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hunter System V2.0 - RPG Habit Tracker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font for the sci-fi look */
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap');
        body {
            font-family: 'Roboto Mono', monospace;
            background-color: #0d1117; /* GitHub Dark Blue */
        }
    </style>
    <!-- Load React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Load Babel for JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Load Firebase SDKs -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import { getFirestore, collection, doc, setDoc, query, where, onSnapshot, updateDoc, getDocs, addDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
      
      // Attach Firebase services to the window for the React component to use
      window.initializeApp = initializeApp;
      window.getAuth = getAuth;
      window.signInWithCustomToken = signInWithCustomToken;
      window.signInAnonymously = signInAnonymously;
      window.onAuthStateChanged = onAuthStateChanged;
      window.getFirestore = getFirestore;
      window.collection = collection;
      window.doc = doc;
      window.setDoc = setDoc;
      window.query = query;
      window.where = where;
      window.onSnapshot = onSnapshot;
      window.updateDoc = updateDoc;
      window.getDocs = getDocs;
      window.addDoc = addDoc;
      window.getDoc = getDoc;
      
      // Load modern React 18 render utility
      window.createRoot = ReactDOM.createRoot;
    </script>
</head>
<body class="bg-gray-900">
    <div id="root"></div>

    <script type="text/babel">
        // Import Lucide Icons (Must be loaded locally since we are in a single HTML file)
        const { Users, Target, Zap, Clock, TrendingUp, Download, Settings, X } = {
            Users: ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            Target: ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>,
            Zap: ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
            Clock: ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            TrendingUp: ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="18 7 22 7 22 11"/></svg>,
            Download: ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
            Settings: ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.2a2 2 0 0 1-1.4 1.4L6 7.5a2 2 0 0 0-1 1.76l.16 2.05a2 2 0 0 1-1.4 1.4L2.5 14a2 2 0 0 0 0 4l1.24.16a2 2 0 0 1 1.4 1.4L7.5 20a2 2 0 0 0 1.76 1l2.05.16a2 2 0 0 1 1.4 1.4V22a2 2 0 0 0 4 0v-.2a2 2 0 0 1-1.4-1.4l1.24-.16a2 2 0 0 0 1.76-1l.16-2.05a2 2 0 0 1 1.4-1.4L22 14a2 2 0 0 0 0-4l-1.24-.16a2 2 0 0 1-1.4-1.4L20 7.5a2 2 0 0 0-1.76-1l-2.05-.16a2 2 0 0 1-1.4-1.4V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            X: ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
        };


        // --- Global Setup (MANDATORY FIREBASE VARIABLES) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? initialAuthToken : null; 

        let app;
        let db;
        let auth;

        if (firebaseConfig) {
            // Use window objects attached above
            app = window.initializeApp(firebaseConfig);
            db = window.getFirestore(app);
            auth = window.getAuth(app);
        }

        // --- CONSTANTS AND THEME ---
        const NEON_BLUE = 'text-[#00F0FF]'; // Main accent color
        const NEON_GREEN = 'text-[#00FF00]'; // Secondary action color
        const BG_DARK = 'bg-gray-900';
        const BORDER_NEON = 'border-[#00F0FF]';

        // LEVEL TITLES for RPG Vibe
        const getRankTitle = (level) => {
            if (level >= 11) return 'Elite Specialist';
            if (level >= 6) return 'Rookie Analyst';
            if (level >= 1) return 'Novice Hunter';
            return 'Unregistered';
        };

        // Simple XP calculation: 10 XP per habit. Streak bonus after 3 days.
        const calculateXPGain = (streak) => {
            if (streak >= 3) return 15; // Streak bonus
            return 10;
        };

        // --- HELPER FUNCTIONS ---

        /** Determines the appropriate RPG greeting based on the current time of day. */
        const getDynamicGreeting = (userName, level) => {
            const hour = new Date().getHours();
            let timePhrase;

            if (hour >= 5 && hour < 12) {
                timePhrase = "Good Morning";
            } else if (hour >= 12 && hour < 18) {
                timePhrase = "Good Afternoon";
            } else {
                timePhrase = "Good Evening";
            }

            // Example based on the prompt's structure
            if (timePhrase === "Good Morning") {
                return `${timePhrase}, Hunter ${userName}! Time to grind.`;
            } else if (timePhrase === "Good Afternoon") {
                return `${timePhrase}, Hunter ${userName}! Your current System Level is ${level}.`;
            } else {
                return `${timePhrase}, Hunter ${userName}! Daily Quests await.`;
            }
        };

        /** Calculates the number of consecutive days a habit has been completed. */
        const calculateStreak = (logs) => {
            if (!logs || logs.length === 0) return 0;
            
            // Sort logs by date descending
            const sortedLogs = logs.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let streak = 0;
            let currentDate = new Date();
            currentDate.setHours(0, 0, 0, 0);

            for (let i = 0; i < sortedLogs.length; i++) {
                const logDate = new Date(sortedLogs[i].date);
                logDate.setHours(0, 0, 0, 0);
                
                const nextDay = new Date(currentDate);
                nextDay.setDate(currentDate.getDate() - 1);

                // Check if the log is from the previous day exactly
                if (logDate.getTime() === currentDate.getTime()) {
                    streak++;
                    currentDate = nextDay; // Move target date back
                } else if (logDate.getTime() < currentDate.getTime()) {
                    // If not today and not yesterday, break
                    break;
                }
            }
            return streak;
        };

        // --- FIREBASE PATHS ---
        const getProfileRef = (userId) => window.doc(db, `/artifacts/${appId}/users/${userId}/profile/info`);
        const getHabitsCollection = (userId) => window.collection(db, `/artifacts/${appId}/users/${userId}/habits`);
        const getRewardsCollection = (userId) => window.collection(db, `/artifacts/${appId}/users/${userId}/rewards`);
        const getLogsCollection = (userId, habitId) => window.collection(db, `/artifacts/${appId}/users/${userId}/habits/${habitId}/logs`);

        // --- MAIN APP COMPONENT ---
        const App = () => {
            const [userId, setUserId] = React.useState(null);
            const [isAuthReady, setIsAuthReady] = React.useState(false);
            const [activeTab, setActiveTab] = React.useState('STATUS WINDOW');
            const [habits, setHabits] = React.useState([]);
            const [rewards, setRewards] = React.useState([]);
            const [xp, setXp] = React.useState(0);
            const [level, setLevel] = React.useState(1);
            const [displayName, setDisplayName] = React.useState('Hunter');
            const [modal, setModal] = React.useState(null); // 'createHabit', 'message', 'settings'
            const [showSettingsPrompt, setShowSettingsPrompt] = React.useState(false);
            // State to store pre-calculated daily completion status to avoid slow reads
            const [completionCache, setCompletionCache] = React.useState({}); 
            const todayISO = new Date().toISOString().split('T')[0];


            // --- FIREBASE AUTH & INIT ---
            React.useEffect(() => {
                if (!firebaseConfig) return console.error("Firebase config not available.");
                
                const signIn = async () => {
                    try {
                        if (initialAuthToken) {
                            await window.signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await window.signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Firebase Auth error:", error);
                        await window.signInAnonymously(auth);
                    }
                };

                const unsubscribe = window.onAuthStateChanged(auth, (user) => {
                    if (user) {
                        setUserId(user.uid);
                    } else {
                        // If auth fails for some reason, use a random ID for anonymous data segregation
                        setUserId(crypto.randomUUID()); 
                    }
                    setIsAuthReady(true);
                });

                signIn();
                return () => unsubscribe();
            }, []);

            // --- DATA SUBSCRIPTIONS ---
            // CONDITIONALLY run effects only when userId is confirmed (isAuthReady is true AND userId is set)
            React.useEffect(() => {
                if (!isAuthReady || !userId || !db) {
                     console.log("Waiting for Auth readiness or User ID...");
                     return;
                }
                
                console.log("Auth Ready. Starting Firestore Subscriptions for user:", userId);

                const profileRef = getProfileRef(userId);

                // 1. Subscribe to Profile/XP Data
                const unsubscribeProfile = window.onSnapshot(profileRef, async (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        setXp(data.xp || 0);
                        setLevel(data.level || 1);
                        setDisplayName(data.displayName || 'Hunter');
                        
                        // Prompt user to set display name if default
                        if (!data.displayName || data.displayName === 'Hunter') {
                            setShowSettingsPrompt(true);
                        }
                    } else {
                        // Initialize profile if it doesn't exist
                        const initialDisplayName = auth.currentUser?.email?.split('@')[0] || 'Hunter';
                        await window.setDoc(profileRef, { xp: 0, level: 1, displayName: initialDisplayName });
                        setDisplayName(initialDisplayName);
                        setShowSettingsPrompt(true);
                    }
                }, (error) => {
                     console.error("Error subscribing to profile:", error);
                });

                // 2. Subscribe to Habits (Daily Quests) - Optimized to include completion status
                const habitsRef = getHabitsCollection(userId);
                const unsubscribeHabits = window.onSnapshot(habitsRef, (snapshot) => {
                    const fetchedHabits = [];
                    const newCache = {};
                    snapshot.forEach(doc => {
                        const habitData = doc.data();
                        fetchedHabits.push({ id: doc.id, ...habitData });
                        
                        // Use pre-calculated field for speed
                        newCache[doc.id] = (habitData.lastClaimDate === todayISO);
                    });
                    setHabits(fetchedHabits);
                    setCompletionCache(newCache); // Update cache for fast access
                }, (error) => {
                     console.error("Error subscribing to habits:", error);
                });

                // 3. Subscribe to Rewards (Inventory)
                const rewardsRef = getRewardsCollection(userId);
                const unsubscribeRewards = window.onSnapshot(rewardsRef, (snapshot) => {
                    const fetchedRewards = [];
                    snapshot.forEach(doc => fetchedRewards.push({ id: doc.id, ...doc.data() }));
                    setRewards(fetchedRewards);
                }, (error) => {
                     console.error("Error subscribing to rewards:", error);
                });

                return () => {
                    unsubscribeProfile();
                    unsubscribeHabits();
                    unsubscribeRewards();
                };
            }, [isAuthReady, userId]);

            // --- PROFILE UPDATE HANDLER ---
            const updateProfileDisplayName = async (newDisplayName) => {
                if (!userId || !newDisplayName) return;
                const profileRef = getProfileRef(userId);
                await window.updateDoc(profileRef, { displayName: newDisplayName });
                setDisplayName(newDisplayName);
                setShowSettingsPrompt(false);
                setModal(null);
            };

            // --- ACTION HANDLERS ---
            const check7DayStreakAndReward = async (habit, logs) => {
                const streak = calculateStreak(logs);
                const rewardRef = getRewardsCollection(userId);
                
                if (streak >= 7 && habit.rewardDescription) {
                    // Check if reward for this streak has already been granted today
                    const q = window.query(rewardRef, window.where('habitId', '==', habit.id), window.where('status', '==', 'UNCLAIMED'));
                    const existingRewards = await window.getDocs(q);

                    if (existingRewards.empty) {
                        await window.addDoc(rewardRef, {
                            name: habit.rewardDescription,
                            status: 'UNCLAIMED',
                            dateUnlocked: new Date().toISOString(),
                            habitId: habit.id,
                        });
                        setModal({ type: 'message', title: 'SYSTEM ALERT', content: `NEW REWARD ITEM UNLOCKED! ${habit.rewardDescription}` });
                        return true;
                    }
                }
                return false;
            };

            const handleClaimExp = async (habit) => {
                if (!userId) return;

                const today = new Date().toISOString().split('T')[0];
                const logRef = getLogsCollection(userId, habit.id);
                const habitDocRef = window.doc(getHabitsCollection(userId), habit.id);
                const todayLogsQuery = window.query(logRef, window.where('date', '==', today));
                const todayLogs = await window.getDocs(todayLogsQuery);

                if (!todayLogs.empty) {
                    setModal({ type: 'message', title: 'WARNING', content: 'EXP ALREADY CLAIMED for this quest today!' });
                    return;
                }

                // 1. Log the completion
                await window.addDoc(logRef, { date: today, claimedAt: new Date().toISOString() });
                
                // --- OPTIMIZATION: Update the habit itself with lastClaimDate ---
                await window.updateDoc(habitDocRef, {
                    lastClaimDate: today, // New field for fast completion check
                });
                
                // 2. Recalculate streak and check for reward (Need to fetch ALL logs to recalculate streak correctly)
                const allLogsSnapshot = await window.getDocs(logRef);
                const allLogs = allLogsSnapshot.docs.map(d => d.data());
                const streak = calculateStreak(allLogs);
                const expGained = calculateXPGain(streak);
                
                await check7DayStreakAndReward(habit, allLogs);

                // 3. Update XP and Level
                const newXp = xp + expGained;
                const newLevel = Math.floor(newXp / 100) + 1; // Simple progression: 100 XP per level
                const profileRef = getProfileRef(userId);
                
                await window.updateDoc(profileRef, {
                    xp: newXp,
                    level: newLevel,
                });

                setModal({ type: 'message', title: 'EXP GAINED', content: `+${expGained} XP! Current Streak: ${streak + 1} days.` });
            };
            
            const handleCreateHabit = async (habitData) => {
                if (!userId) return;
                const habitsRef = getHabitsCollection(userId);
                try {
                    await window.addDoc(habitsRef, {
                        name: habitData.name,
                        rewardDescription: habitData.rewardDescription,
                        createdAt: new Date().toISOString(),
                        status: 'ACTIVE',
                        lastClaimDate: null, // Initialize new field
                    });
                    setModal(null);
                } catch (error) {
                    console.error("Error creating habit:", error);
                }
            };

            const handleClaimReward = async (rewardId) => {
                if (!userId) return;
                const rewardRef = window.doc(getRewardsCollection(userId), rewardId);
                await window.updateDoc(rewardRef, { status: 'CLAIMED', dateClaimed: new Date().toISOString() });
                setModal({ type: 'message', title: 'REWARD CLAIMED', content: 'Biryani time! Enjoy your earned reward.' });
            };
            
            // --- MEMORIZED/DERIVED STATE ---

            const currentExp = xp % 100; // XP within the current level (0-99)
            const expToNextLevel = 100;
            const progressPercent = (currentExp / expToNextLevel) * 100;

            // --- SUB-COMPONENTS ---

            const SettingsModal = ({ onSave }) => {
                const [name, setName] = React.useState(displayName);

                return (
                    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75 p-4">
                        <div className={`${BG_DARK} border-2 ${BORDER_NEON} p-6 rounded-lg shadow-xl w-full max-w-sm`}>
                            <h3 className={`text-xl font-bold ${NEON_BLUE} flex justify-between items-center`}>
                                SYSTEM SETTINGS
                                <button onClick={() => { setShowSettingsPrompt(false); setModal(null); }} className="text-gray-500 hover:text-white"><X className="w-5 h-5" /></button>
                            </h3>
                            <p className="mt-4 text-gray-300">Set your **Hunter Display Name** for the greeting.</p>
                            <input
                                type="text"
                                placeholder="e.g., SungJinWoo, Bhradwaj"
                                value={name}
                                onChange={(e) => setName(e.target.value)}
                                className={`w-full p-3 mt-4 rounded bg-gray-800 ${BORDER_NEON} border text-white focus:outline-none focus:ring-1 focus:ring-[#00F0FF]`}
                            />
                            <button
                                onClick={() => onSave(name)}
                                className={`mt-6 w-full py-2 rounded font-bold transition duration-200 ${NEON_GREEN} border border-[#00FF00] hover:bg-[#00FF00] hover:text-gray-900`}
                            >
                                SAVE & CONTINUE
                            </button>
                        </div>
                    </div>
                );
            };

            const MessageModal = ({ onClose }) => (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75 p-4">
                    <div className={`${BG_DARK} border-2 ${BORDER_NEON} p-6 rounded-lg shadow-xl w-full max-w-sm`}>
                        <h3 className={`text-xl font-bold ${NEON_BLUE}`}>{modal.title}</h3>
                        <p className="mt-4 text-gray-300">{modal.content}</p>
                        <button
                            onClick={onClose}
                            className={`mt-6 w-full py-2 rounded font-bold transition duration-200 ${NEON_GREEN} border border-[#00FF00] hover:bg-[#00FF00] hover:text-gray-900`}
                        >
                            ACKNOWLEDGE
                        </button>
                    </div>
                </div>
            );
            
            const CreateHabitModal = ({ onClose }) => {
                const [name, setName] = React.useState('');
                const [reward, setReward] = React.useState('');

                const handleSubmit = () => {
                    if (name && reward) {
                        handleCreateHabit({ name, rewardDescription: reward });
                    }
                };
                
                return (
                    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75 p-4">
                        <div className={`${BG_DARK} border-2 ${BORDER_NEON} p-6 rounded-lg shadow-xl w-full max-w-lg`}>
                            <h3 className={`text-xl font-bold ${NEON_BLUE} mb-4`}>CREATE NEW QUEST</h3>
                            <div className="space-y-4">
                                <input
                                    type="text"
                                    placeholder="Quest Name (e.g., Meditate 10 Mins)"
                                    value={name}
                                    onChange={(e) => setName(e.target.value)}
                                    className={`w-full p-3 rounded bg-gray-800 ${BORDER_NEON} border text-white focus:outline-none focus:ring-1 focus:ring-[#00F0FF]`}
                                />
                                <input
                                    type="text"
                                    placeholder="7-Day Reward (e.g., Biryani Pass Unlocked!)"
                                    value={reward}
                                    onChange={(e) => setReward(e.target.value)}
                                    className={`w-full p-3 rounded bg-gray-800 ${BORDER_NEON} border text-white focus:outline-none focus:ring-1 focus:ring-[#00F0FF]`}
                                />
                            </div>
                            <div className="flex justify-end space-x-4 mt-6">
                                <button
                                    onClick={onClose}
                                    className="py-2 px-4 rounded font-bold text-gray-400 border border-gray-700 hover:border-gray-500 transition duration-200"
                                >
                                    CANCEL
                                </button>
                                <button
                                    onClick={handleSubmit}
                                    className={`py-2 px-4 rounded font-bold transition duration-200 ${NEON_GREEN} border border-[#00FF00] hover:bg-[#00FF00] hover:text-gray-900`}
                                >
                                    ACTIVATE QUEST
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };
            
            const StatusWindow = () => {
                const greeting = getDynamicGreeting(displayName, level);

                const XPBar = ({ value, max, label, color }) => (
                    <div className="mb-4">
                        <div className="flex justify-between text-xs font-mono text-gray-400">
                            <span>{label}</span>
                            <span className={color}>{value}/{max}</span>
                        </div>
                        <div className="w-full bg-gray-800 h-2 rounded-full mt-1">
                            <div
                                className={`h-full rounded-full transition-all duration-500 ${color === NEON_BLUE ? 'bg-[#00F0FF] shadow-[0_0_8px_#00F0FF]' : 'bg-[#00FF00] shadow-[0_0_8px_#00FF00]'}`}
                                style={{ width: `${(value / max) * 100}%` }}
                            ></div>
                        </div>
                    </div>
                );

                const StatCard = ({ title, value, icon: Icon, colorClass }) => {
                    // Placeholder for Mana/Focus calculation based on habits claimed today
                    const dailyManaStart = 100;
                    const completedTodayCount = habits.filter(h => completionCache[h.id]).length;
                    const currentMana = dailyManaStart - (completedTodayCount * 15);
                    const totalQuests = habits.length;
                    const completionPercent = totalQuests > 0 ? Math.round((completedTodayCount / totalQuests) * 100) : 0;
                    
                    let statValue = value;
                    if (title === "MANA / FOCUS") statValue = `${Math.max(0, currentMana)}%`;
                    if (title === "TODAY'S COMPLETION") statValue = `${completionPercent}%`;

                    return (
                        <div className={`p-4 ${BG_DARK} rounded-lg border border-gray-700 shadow-lg shadow-gray-800/50`}>
                            <div className="flex items-center space-x-3">
                                <Icon className={`w-6 h-6 ${colorClass}`} />
                                <div>
                                    <p className="text-sm text-gray-400">{title}</p>
                                    <p className={`text-xl font-bold ${colorClass}`}>{statValue}</p>
                                </div>
                            </div>
                        </div>
                    );
                };
                
                return (
                    <div className="p-6 space-y-8">
                        {/* SYSTEM ALERT / GREETING */}
                        <div className={`p-4 border-2 ${BORDER_NEON} rounded-lg bg-gray-800 shadow-[0_0_15px_#00F0FF]`}>
                            <p className={`font-mono text-sm uppercase ${NEON_BLUE} mb-1`}>— SYSTEM ALERT —</p>
                            <p className={`text-xl font-bold text-white`}>{greeting}</p>
                        </div>

                        {/* LEVEL AND PROGRESS */}
                        <div className="space-y-2 p-4 border border-gray-700 rounded-lg">
                            <div className={`flex items-baseline space-x-2 ${NEON_GREEN}`}>
                                <span className="text-3xl font-extrabold">LEVEL {level}</span>
                                <span className="text-lg text-gray-400">({getRankTitle(level)})</span>
                            </div>
                            <XPBar value={currentExp} max={expToNextLevel} label={`PROGRESS TO LEVEL ${level + 1}`} color={NEON_BLUE} />
                            <p className="text-xs text-gray-500 pt-2">EXP: {xp} Total | {expToNextLevel - currentExp} EXP TO LEVEL {level + 1}</p>
                        </div>

                        {/* HUNTER STATS */}
                        <h3 className={`text-xl font-bold ${NEON_BLUE}`}>HUNTER STATS</h3>
                        <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <StatCard 
                                title="MANA / FOCUS" 
                                value="N/A" 
                                icon={Zap} 
                                colorClass={NEON_GREEN} 
                            />
                            <StatCard 
                                title="REWARDS PENDING" 
                                value={rewards.filter(r => r.status === 'UNCLAIMED').length} 
                                icon={TrendingUp} 
                                colorClass={NEON_BLUE} 
                            />
                            <StatCard 
                                title="TODAY'S COMPLETION" 
                                value="N/A" 
                                icon={Target} 
                                colorClass={NEON_GREEN} 
                            />
                        </div>
                    </div>
                );
            };

            const DailyQuests = () => {
                // Placeholder for CSV Export
                const handleExportCSV = () => {
                    setModal({ type: 'message', title: 'EXPORT UNAVAILABLE', content: 'CSV export functionality requires external processing and is not implemented in this version. Data is safely stored in Firestore.' });
                };
                
                const handleClaimWrapper = async (habit) => {
                    await handleClaimExp(habit);
                };
                
                return (
                    <div className="p-6 space-y-6">
                        <div className="flex justify-between items-center">
                            <h3 className={`text-xl font-bold ${NEON_BLUE}`}>ACTIVE QUESTS</h3>
                            <div className="flex space-x-2">
                                <button 
                                    onClick={handleExportCSV}
                                    className={`py-2 px-4 rounded font-bold transition duration-200 ${NEON_BLUE} border border-[#00F0FF] hover:bg-[#00F0FF] hover:text-gray-900 flex items-center text-sm`}
                                >
                                    <Download className="w-4 h-4 mr-2" />
                                    EXPORT DATA
                                </button>
                                <button
                                    onClick={() => setModal({ type: 'createHabit', onClose: () => setModal(null) })}
                                    className={`py-2 px-4 rounded font-bold transition duration-200 ${NEON_GREEN} border border-[#00FF00] hover:bg-[#00FF00] hover:text-gray-900 text-sm`}
                                >
                                    CREATE NEW QUEST
                                </button>
                            </div>
                        </div>

                        {habits.length === 0 && (
                            <p className="text-gray-500 pt-4">No Quests active. Click 'CREATE NEW QUEST' to begin your Hunter journey.</p>
                        )}

                        <div className="space-y-4">
                            {habits.map((habit) => {
                                // Use fast cache lookup
                                const completed = completionCache[habit.id] || false; 
                                
                                return (
                                    <div key={habit.id} className="p-4 bg-gray-800 rounded-lg border border-gray-700 flex flex-col sm:flex-row justify-between items-start sm:items-center">
                                        <div className="flex-1 min-w-0 pr-4">
                                            <p className="text-lg font-semibold text-white truncate">{habit.name}</p>
                                            <p className="text-sm text-gray-400">Reward: {habit.rewardDescription || 'N/A'}</p>
                                        </div>
                                        <div className="flex items-center space-x-4 mt-3 sm:mt-0">
                                            <span className={`text-sm font-mono ${completed ? NEON_GREEN : NEON_BLUE}`}>
                                                <Clock className="w-4 h-4 inline mr-1" /> STATUS: {completed ? 'COMPLETED' : 'PENDING'}
                                            </span>
                                            <button
                                                onClick={() => handleClaimWrapper(habit)}
                                                disabled={completed}
                                                className={`py-2 px-4 rounded font-bold transition duration-200 ${completed ? 'bg-gray-700 text-gray-500' : `${NEON_GREEN} border border-[#00FF00] hover:bg-[#00FF00] hover:text-gray-900`}`}
                                            >
                                                {completed ? 'COMPLETED' : 'CLAIM EXP'}
                                            </button>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            };

            const RewardsInventory = () => (
                <div className="p-6 space-y-6">
                    <h3 className={`text-xl font-bold ${NEON_BLUE}`}>EARNED REWARDS</h3>
                    {rewards.filter(r => r.status === 'UNCLAIMED').length === 0 && (
                        <p className="text-gray-500 pt-4">Complete 7-day streaks to earn rewards!</p>
                    )}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {rewards.filter(r => r.status === 'UNCLAIMED').map(reward => (
                            <div key={reward.id} className="p-4 bg-gray-800 rounded-lg border border-[#00FF00] shadow-[0_0_10px_#00FF00]">
                                <p className={`text-lg font-semibold ${NEON_GREEN}`}>{reward.name}</p>
                                <p className="text-sm text-gray-400">Status: UNCLAIMED</p>
                                <p className="text-xs text-gray-500">Unlocked: {new Date(reward.dateUnlocked).toLocaleDateString()}</p>
                                <button
                                    onClick={() => handleClaimReward(reward.id)}
                                    className="mt-3 py-1 px-3 text-xs rounded font-bold text-white bg-red-600 hover:bg-red-700 transition duration-200"
                                >
                                    SPEND/CLAIM REWARD
                                </button>
                            </div>
                        ))}
                    </div>
                    <h4 className={`text-lg font-bold text-gray-500 mt-8`}>CLAIMED HISTORY</h4>
                    <div className="space-y-2 text-gray-600">
                        {rewards.filter(r => r.status === 'CLAIMED').map(reward => (
                            <p key={reward.id} className="text-sm border-b border-gray-800 pb-1">
                                {reward.name} - Claimed on {new Date(reward.dateClaimed).toLocaleDateString()}
                            </p>
                        ))}
                    </div>
                </div>
            );

            const renderContent = () => {
                // Keep the 'Initializing System...' screen minimal for fast loading
                if (!isAuthReady) {
                    return <div className="text-center p-10 text-gray-400">Initializing System...</div>;
                }

                switch (activeTab) {
                    case 'STATUS WINDOW': return <StatusWindow />;
                    case 'DAILY QUESTS': return <DailyQuests />;
                    case 'REWARDS INVENTORY': return <RewardsInventory />;
                    default: return <StatusWindow />;
                }
            };

            return (
                <div className={`min-h-screen ${BG_DARK} text-white font-sans antialiased`}>
                    {/* Header / System Title */}
                    <header className={`p-4 shadow-lg ${BG_DARK} sticky top-0 z-10 border-b border-gray-700`}>
                        <div className="max-w-4xl mx-auto flex justify-between items-center">
                            <h1 className={`text-2xl font-extrabold tracking-widest ${NEON_BLUE}`}>HUNTER SYSTEM V2.0</h1>
                            <div className="flex items-center space-x-4">
                                <span className="text-xs text-gray-500">USER: {displayName}</span>
                                <button 
                                    onClick={() => setShowSettingsPrompt(true)} 
                                    className="text-gray-400 hover:text-white transition"
                                    aria-label="Settings"
                                >
                                    <Settings className="w-5 h-5" />
                                </button>
                            </div>
                        </div>
                    </header>

                    {/* Main Content Area */}
                    <main className="max-w-4xl mx-auto pb-10">
                        {/* Tabs / Navigation */}
                        <div className="flex justify-center p-4 space-x-2 border-b border-gray-700 sticky top-16 bg-gray-900 z-10">
                            {['STATUS WINDOW', 'DAILY QUESTS', 'REWARDS INVENTORY'].map(tab => (
                                <button
                                    key={tab}
                                    onClick={() => setActiveTab(tab)}
                                    className={`px-4 py-2 text-sm font-bold uppercase rounded-t transition duration-200 ${
                                        activeTab === tab
                                            ? `bg-gray-800 ${NEON_BLUE} border-b-2 border-[#00F0FF] shadow-[0_4px_10px_rgba(0,240,255,0.3)]`
                                            : 'text-gray-400 hover:text-white'
                                    }`}
                                >
                                    {tab}
                                </button>
                            ))}
                        </div>

                        {/* Content */}
                        {renderContent()}
                    </main>

                    {/* Modal Renderer */}
                    {(modal && modal.type === 'message') && <MessageModal onClose={() => setModal(null)} />}
                    {(modal && modal.type === 'createHabit') && <CreateHabitModal onClose={() => setModal(null)} />}
                    {showSettingsPrompt && <SettingsModal onSave={updateProfileDisplayName} />}
                </div>
            );
        };

        // --- MODERN REACT 18 RENDER ---
        const root = window.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>
